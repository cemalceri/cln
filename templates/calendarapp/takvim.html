{% extends 'base/base.html' %}
{% load static %}
{% block title %}Event Calendar{% endblock title %}

{% block extracss %}
    <link href="{% static 'calender/main.css' %}" rel="stylesheet"/>
{% endblock extracss %}

{% block breadcrumb %}
    <div>
        <h1><i class="fa fa-calendar"></i> Calendar</h1>
        <p>Event Calendar</p>
    </div>
    <ul class="app-breadcrumb breadcrumb">
        <li class="breadcrumb-item"><i class="fa fa-home fa-lg"></i></li>
        <li class="breadcrumb-item"><a href="#">Calendar</a></li>
    </ul>
{% endblock breadcrumb %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="tile row">
                <div class="col-md-2">
                    <div id="external-events">
                        <h4 class="mb-4">Aktif Rezervasyonlar</h4>
                        {% for rezervasyon in aktif_rezervasyonlar %}
                            <div class="fc-event">
                                <h3>{{ rezervasyon.baslik }}</h3>
                                <p>Baslangıç: {{ rezervasyon.baslangic_tarih_saat }}</p>
                                <p>Bitiş: {{ rezervasyon.bitis_tarih_saat }}</p>
                            </div>
                        {% empty %}
                            <p>Aktif Rezervasyon Bulunamadı</p>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-10">
                    <div id="calendar"></div>
                </div>

                <div class="modal fade show" id="eventModal" tabindex="-1" role="dialog"
                     aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header bg-primary">
                                <h5 class="modal-title text-white" id="exampleModalLongTitle">Rezervasyon Ekle</h5>
                                <button id="modalClose1" type="button" class="close" data-dismiss="modal"
                                        aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <form method="post" action="{% url 'calendarapp:kaydet_rezervasyon_ajax' %}">
                                {% csrf_token %}
                                <div class="modal-body">
                                    {% for field in form %}
                                        <div class="form-group">
                                            {% if field.name != 'pk' %}
                                                <label for="message-text"
                                                       class="col-form-label">{{ field.label_tag }}</label>
                                            {% endif %}
                                            {{ field }}
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="modal-footer">
                                    <button id="modalClose2" type="button" class="btn btn-secondary">Kapat</button>
                                    <button id="btnSil" onclick="RezervasyonSil()" type="button"
                                            class="btn btn-danger">Temizle
                                    </button>
                                    <button type="submit" class="btn btn-primary">Kaydet</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block extrascripts %}
    <script src="{% static 'calender/main.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var today = new Date();

            var calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,list',
                },
                initialDate: today,
                initalView: 'd',
                navLinks: true, // can click day/week names to navigate views
                selectable: true,
                selectMirror: true,
                select: function (arg) {
                    console.log('clicked')
                    clearModalFields();
                    //Burası düzeltilecek
                    $("#id_baslangic_tarih_saat").val(new Date(arg.start.toUTCString()).toJSON().slice(0, 19));
                    $("#id_bitis_tarih_saat").val(new Date(arg.end.toUTCString()).toJSON().slice(0, 19));
                    console.log(arg.start.toUTCString())
                    console.log(arg.end.toUTCString())
                    var modal = document.getElementById('eventModal')
                    modal.style.display = 'block'
                    calendar.unselect()
                },
                // THIS KEY WON'T WORK IN PRODUCTION!!!
                // To make your own Google API key, follow the directions here:
                // http://fullcalendar.io/docs/google_calendar/
                // googleCalendarApiKey: 'AIzaSyCqCxjjLtjbtkX37aOtWB8OfwBLy_6QuYk',

                // bangladesh Holidays
                // events: 'bn.bd#holiday@group.v.calendar.google.com',
                eventClick: function (arg) {
                    // if (confirm('Bu Rezervasyon silinsin mi?')) {
                    //     arg.event.remove()
                    // }
                    document.getElementById("btnSil").innerText = "Sil"
                    openEditModal(arg.event);
                },
                eventDragStop: function (arg) {
                    console.log("sürükle başladı")
                },
                eventDragStart: function (arg) {
                    console.log("sürükle bitti")
                },
                eventAdd: function (arg) {
                    console.log("eklendi")
                },
                editable: true,
                dayMaxEvents: true, // allow "more" link when too many events
                events: {{ events|safe }},
                // events: [
                //   {
                //     title: 'All Day Event',
                //     start: '2021-06-26'
                //   },
                //   {
                //     groupId: 999,
                //     title: 'Repeating Event',
                //     start: '2020-09-16T16:00:00'
                //   },
                //   {
                //     title: 'Conference',
                //     start: '2020-09-11',
                //     end: '2020-09-13'
                //   },
                //   {
                //     title: 'Click for Google',
                //     url: 'http://google.com/',
                //     start: '2020-09-28'
                //   }
                // ]
            });
            calendar.render();
        });
        const closeBtn1 = document.getElementById('modalClose1');
        const closeBtn2 = document.getElementById('modalClose2');
        closeBtn1.addEventListener('click', () => {
            const eventModal = document.getElementById('eventModal')
            eventModal.style.display = 'none';
        });
        closeBtn2.addEventListener('click', () => {
            const eventModal = document.getElementById('eventModal')
            eventModal.style.display = 'none';
        });

        //function to open modal with event details
        function openEditModal(event) {
            document.getElementById('id_pk').value = event.id;
            $.ajax({
                url: '{% url 'calendarapp:getir_rezervasyon_bilgisi_by_id' %}',
                type: 'GET',
                data: {
                    'id': event.id
                },
                success: function (data) {
                    const eventModal = document.getElementById('eventModal')
                    eventModal.style.display = 'block';
                    for (let item in data) {
                        if (data[item] != "null" || data[item] != "undefined" || data[item] != "") {
                            let key = item == 'id' ? 'pk' : item
                            let element = document.getElementById("id_" + key);
                            if (element)
                                element.value = data[item];
                        }
                    }
                }
            });
        }

        function RezervasyonSil() {
            id = document.getElementById("id_pk").value;
            if (id) {
                if (confirm('Bu Rezervasyon silinsin mi?')) {
                    $.ajax({
                        url: '{% url 'calendarapp:sil_rezervasyon_by_id' %}',
                        type: 'GET',
                        data: {
                            'id': id
                        },
                        success: function (data) {
                            location.reload();
                        }
                    });
                }
            } else
                clearModalFields();
        }

        //function clear modal fields
        function clearModalFields() {
            let elements = document.getElementsByClassName("form-control");
            for (let i = 0; i < elements.length; i++) {
                elements[i].value = "";
            }
        }
    </script>
{% endblock extrascripts %}
